#!/usr/bin/env bash
varg=$(< ~/.system/max-volume)
name=$(basename $0)
i3volumefix="pkill -RTMIN+1 i3blocks"
ismusic(){
	[[ "$(mpc status | wc -l)" != "1" ]]
}
isjack(){
	[[ "$(grep -c "Pin-ctls: 0x00" /proc/asound/card0/codec\#0)" == "2" ]]
}
ismute(){
	[[ "$(awk '/muted/ {print $2}' <(pacmd list-sinks))" == "yes" ]]
}
case "$1" in
"up")
	pamixer $varg -i "$2"
	$i3volumefix ;;
"down")
	pamixer $varg -d "$2"
	$i3volumefix ;;
"vol")
	pamixer $varg --set-volume "$2"
	$i3volumefix ;;
"tmute")
	pamixer -t
	$i3volumefix ;;
"mute")
	pamixer -m
	$i3volumefix ;;
"tmax")
	[[ "$varg" != "--allow-boost" ]] && m="--allow-boost" || m=""
	echo "$m" > ~/.system/max-volume
	$i3volumefix ;;
"getvol")
	pamixer --get-volume ;;
"ismute")
	ismute ;;
"isjack")
	isjack ;;
"ismusic")
	ismusic ;;
"replay")
	mpc seek 0% ;;
"backward")
	mpc seek -"$2" ;;
"forward")
	mpc seek +"$2" ;;
"tplay")
	mpc toggle
	echo '{"command": ["cycle", "pause"]}' | socat - ~/.tmp/mpvsocket
	playerctl play-pause ;;
"pause")
	mpc pause
	echo '{ "command": ["set_property", "pause", true] }' | socat - ~/.tmp/mpvsocket
	playerctl pause ;;
"play")
	mpc play
	echo '{ "command": ["set_property", "pause", false] }' | socat - ~/.tmp/mpvsocket
	playerctl play ;;
"next")
	mpc next ;;
"prev")
	mpc prev ;;
"clear")
	mpc clear ;;
"randadd")
	mpc listall | shuf -n $2 | mpc add ;;
"help")
	printf "Commands:\n"
	printf "  $name up <num>             Increase system volume\n"
	printf "  $name down <num>           Decrease system volume\n"
	printf "  $name vol <num>            Set system volume\n"
	printf "  $name tmute                 Toggle system volume mute\n"
	printf "  $name mute                  Mute system volume\n"
	printf "  $name tmax                  Toggle system volume boost\n"
	printf "  $name getvol                Get the system volume\n"
	printf "  $name ismute                Check if the system volume is muted\n"
	printf "  $name isjack                Check if headphones are plugged in \n"
	printf "  $name ismusic               Check if music is playing\n"
	printf "  $name replay                Replay the current song\n"
	printf "  $name backward <seconds>    Jump backward in a song\n"
	printf "  $name forward <seconds>     Jump forward in a song\n"
	printf "  $name tplay                 Toggle whether a song is played or paused\n"
	printf "  $name pause                 Pause a song\n"
	printf "  $name play                  Play a song\n"
	printf "  $name next                  Go to the next song\n"
	printf "  $name prev                  Go to the prev song\n"
	printf "  $name clear                 Clear the mpd queue\n"
	printf "  $name randadd <number>      Add random songs to the queue\n"
	printf "  $name help                  Display this message\n" ;;
*)
	ismusic && printf "$(mpc current)\n$(mpc status | sed -n '2p' | sed 's/\[\(.*\)\] \(.*\)   \(.*\) .*/\1 - \2 - \3/g')\n"
	echo "$(pamixer --get-volume) - $(ismute && printf "mute" || printf "nomute") - $(isjack && printf "jack" || printf "nojack")"
esac
